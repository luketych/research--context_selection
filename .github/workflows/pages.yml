name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Create site structure
        run: |
          # Create a simple directory structure for the site
          mkdir -p _site
          
          # Copy only visible files from main branch
          if [ -d "test/descriptions" ]; then
            mkdir -p _site/test/descriptions
            cp -r test/descriptions/* _site/test/descriptions/ 2>/dev/null || true
          fi
          
          if [ -d "descriptions" ]; then
            mkdir -p _site/descriptions
            cp -r descriptions/* _site/descriptions/ 2>/dev/null || true
          fi
          
          # Copy important project files
          [ -f "README.md" ] && cp README.md _site/
          [ -f "CLAUDE.md" ] && cp CLAUDE.md _site/
          
          # Create an index.html for better navigation
          cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Context Selection Documentation</title>
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 40px; }
                  .file-list { list-style: none; padding: 0; }
                  .file-list li { margin: 8px 0; }
                  .file-list a { color: #0969da; text-decoration: none; }
                  .file-list a:hover { text-decoration: underline; }
                  .directory { font-weight: 600; color: #656d76; }
              </style>
          </head>
          <body>
              <h1>Context Selection Documentation</h1>
              <p>This site exposes only the files visible according to the current visibility settings.</p>
              
              <h2>Available Files</h2>
              <ul class="file-list" id="fileList">
                  <!-- Files will be populated by JavaScript -->
              </ul>
              
              <script>
                  // Simple file discovery script
                  const commonPaths = [
                      'README.md',
                      'CLAUDE.md',
                      'test/descriptions/overview.md',
                      'test/descriptions/architecture.md',
                      'test/descriptions/api-reference.md',
                      'test/descriptions/getting-started.md',
                      'test/descriptions/troubleshooting.md',
                      'test/descriptions/deployment.md',
                      'descriptions/overview.md',
                      'descriptions/architecture.md'
                  ];
                  
                  const fileList = document.getElementById('fileList');
                  
                  commonPaths.forEach(path => {
                      fetch(path, { method: 'HEAD' })
                          .then(response => {
                              if (response.ok) {
                                  const li = document.createElement('li');
                                  const a = document.createElement('a');
                                  a.href = path;
                                  a.textContent = path;
                                  li.appendChild(a);
                                  fileList.appendChild(li);
                              }
                          })
                          .catch(() => {}); // Ignore errors for missing files
                  });
              </script>
          </body>
          </html>
          EOF
          
          # List what we're deploying
          echo "Files being deployed to GitHub Pages:"
          find _site -type f | sort
          
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4